{% load static %}<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ÊñáÊ°£</title>
    <!-- Swagger UI Ê†∑Âºè -->
    <link rel="stylesheet" type="text/css" href="{% static 'drf_resource/swagger-ui/swagger-ui.css' %}">
    <style>
        /* ÈáçÁΩÆÊ†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3a8ee6;
            --primary-hover: #2d7ad6;
            --primary-light: #ecf5ff;
            --bg-color: #f5f7fa;
            --bg-white: #ffffff;
            --text-primary: #303133;
            --text-secondary: #606266;
            --text-placeholder: #c0c4cc;
            --border-color: #e4e7ed;
            --border-light: #f0f0f0;
            --method-get: #67c23a;
            --method-post: #409eff;
            --method-put: #e6a23c;
            --method-delete: #f56c6c;
            --method-patch: #e91e63;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* È°µÈù¢ÂÆπÂô® */
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Â∑¶‰æßËæπÊ†è */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.85;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }

        /* ÂàÜÁªÑÂØºËà™ */
        .group-item {
            border-bottom: 1px solid var(--border-light);
        }

        .group-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }

        .group-header:hover {
            background-color: var(--bg-color);
        }

        .group-header.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        .group-arrow {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            color: #909399;
            font-size: 12px;
        }

        .group-arrow.expanded {
            transform: rotate(90deg);
        }

        .group-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
            background-color: #f0f2f5;
        }

        .group-info {
            flex: 1;
            min-width: 0;
        }

        .group-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-count {
            font-size: 12px;
            color: #909399;
            background-color: #f0f2f5;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .group-header.active .group-count {
            background-color: var(--primary-color);
            color: #fff;
        }

        /* Â≠êÂàÜÁªÑ */
        .subgroup-list {
            display: none;
            background-color: #fafbfc;
        }

        .subgroup-list.expanded {
            display: block;
        }

        .subgroup-item {
            display: flex;
            align-items: center;
            padding: 10px 16px 10px 46px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .subgroup-item:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }

        .subgroup-item.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 500;
        }

        .subgroup-prefix {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .subgroup-count {
            font-size: 11px;
            color: #909399;
            background-color: #e8e8e8;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .subgroup-item.active .subgroup-count {
            background-color: var(--primary-color);
            color: #fff;
        }

        /* ÂµåÂ•óÂ≠êÂàÜÁªÑÊ†∑Âºè */
        .subgroup-item-wrapper {
            width: 100%;
        }

        .subgroup-item.has-children {
            position: relative;
        }

        .subgroup-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 10px;
            color: #909399;
            transition: transform 0.2s;
            margin-right: 4px;
        }

        .subgroup-arrow.expanded {
            transform: rotate(90deg);
        }

        .subgroup-badge {
            font-size: 10px;
            color: #909399;
            background-color: #f0f2f5;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 6px;
        }

        .nested-subgroup-list {
            background-color: #f5f7fa;
        }

        .nested-subgroup-list .subgroup-item {
            border-left: 2px solid var(--border-color);
        }

        .nested-subgroup-list .subgroup-item:hover {
            border-left-color: var(--primary-color);
        }

        .nested-subgroup-list .subgroup-item.active {
            border-left-color: var(--primary-color);
        }

        /* ‰∏≠Èó¥‰∏ªÂå∫Âüü */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-white);
        }

        /* È°∂ÈÉ®Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-white);
            flex-wrap: wrap;
        }

        .toolbar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-right: auto;
        }

        .toolbar-title small {
            font-weight: normal;
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        /* ÊêúÁ¥¢Ê°Ü */
        .search-wrapper {
            position: relative;
            width: 280px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-placeholder);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-placeholder);
            font-size: 14px;
        }

        /* HTTP ÊñπÊ≥ïËøáÊª§ÊåâÈíÆ */
        .method-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .method-filter-label {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .method-filter-btns {
            display: flex;
            gap: 6px;
        }

        .method-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .method-btn:hover {
            opacity: 0.9;
        }

        .method-btn.active {
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .method-btn.all {
            background-color: #f0f2f5;
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        .method-btn.all.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .method-btn.get {
            background-color: #e8f5e9;
            color: var(--method-get);
        }

        .method-btn.get.active {
            background-color: var(--method-get);
            color: #fff;
        }

        .method-btn.post {
            background-color: #e3f2fd;
            color: var(--method-post);
        }

        .method-btn.post.active {
            background-color: var(--method-post);
            color: #fff;
        }

        .method-btn.put {
            background-color: #fff3e0;
            color: var(--method-put);
        }

        .method-btn.put.active {
            background-color: var(--method-put);
            color: #fff;
        }

        .method-btn.delete {
            background-color: #ffebee;
            color: var(--method-delete);
        }

        .method-btn.delete.active {
            background-color: var(--method-delete);
            color: #fff;
        }

        /* Swagger UI ÂÆπÂô® */
        .swagger-container {
            flex: 1;
            overflow-y: auto;
        }

        /* Ëá™ÂÆö‰πâ Swagger UI Ê†∑Âºè */
        .swagger-ui .topbar {
            display: none;
        }

        .swagger-ui .info {
            margin: 20px 0;
        }

        .swagger-ui .scheme-container {
            padding: 10px 20px;
            background: var(--bg-color);
        }

        .swagger-ui .opblock-tag {
            border-bottom: 1px solid var(--border-color);
        }

        .swagger-ui .opblock-tag-section h3 {
            font-size: 18px;
        }

        /* ÊêúÁ¥¢Ê°Ü - Â∑¶‰æßËæπÊ†è */
        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .sidebar-search-input:focus {
            border-color: var(--primary-color);
        }

        .sidebar-search-input::placeholder {
            color: var(--text-placeholder);
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #909399;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Á©∫Áä∂ÊÄÅ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #909399;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 14px;
            text-align: center;
        }

        /* ÈîôËØØÁä∂ÊÄÅ */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #f56c6c;
        }

        .error-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .retry-btn {
            padding: 8px 20px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 16px;
        }

        .retry-btn:hover {
            background-color: var(--primary-hover);
        }

        /* ÂìçÂ∫îÂºèÈÄÇÈÖç */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
                min-width: 240px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .search-wrapper {
                width: 100%;
            }

            .method-filter {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â∑¶‰æßËæπÊ†è -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>API ÊñáÊ°£</h1>
                <p>ÂÖ± <span id="total-groups">0</span> ‰∏™ÂàÜÁªÑÔºå<span id="total-apis">0</span> ‰∏™Êé•Âè£</p>
            </div>
            <div class="search-box">
                <input type="text" class="sidebar-search-input" placeholder="ÊêúÁ¥¢ÂàÜÁªÑ..." id="sidebar-search-input">
            </div>
            <div class="sidebar-content" id="group-list">
                <!-- ÂàÜÁªÑÂàóË°®Áî± JS Âä®ÊÄÅÊ∏≤Êüì -->
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Âä†ËΩΩÂàÜÁªÑ‰∏≠...</div>
                </div>
            </div>
        </aside>

        <!-- ‰∏≠Èó¥‰∏ªÂå∫Âüü -->
        <main class="main-content">
            <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
            <div class="toolbar">
                <div class="toolbar-title" id="toolbar-title">
                    API ÊñáÊ°£
                    <small id="toolbar-subtitle">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ</small>
                </div>
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="ÊêúÁ¥¢ APIÔºàÊîØÊåÅË∑ØÂæÑÂíåÊèèËø∞Ôºâ..." id="api-search-input">
                </div>
                <div class="method-filter">
                    <span class="method-filter-label">Âø´Êç∑ËøáÊª§Ôºö</span>
                    <div class="method-filter-btns" id="method-filter-btns">
                        <span class="method-btn all active" data-method="">ÂÖ®ÈÉ®</span>
                        <span class="method-btn get" data-method="get">GET</span>
                        <span class="method-btn post" data-method="post">POST</span>
                        <span class="method-btn put" data-method="put">PUT</span>
                        <span class="method-btn delete" data-method="delete">DELETE</span>
                    </div>
                </div>
            </div>
            <!-- Swagger UI ÂÆπÂô® -->
            <div class="swagger-container" id="swagger-ui">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div class="empty-state-text">ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑÊü•Áúã API ÊñáÊ°£</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Swagger UI Bundle -->
    <script src="{% static 'drf_resource/swagger-ui/swagger-ui-bundle.js' %}"></script>
    <script src="{% static 'drf_resource/swagger-ui/swagger-ui-standalone-preset.js' %}"></script>

    <script>
        // ==================== ÈÖçÁΩÆ ====================
        const CONFIG = {
            tagsUrl: '{{ tags_url|default:"/docs/tags/" }}',
            schemaUrl: '{{ schema_url|default:"/schema/" }}',
            debounceDelay: 300
        };

        // ==================== Áä∂ÊÄÅÁÆ°ÁêÜ ====================
        const AppState = {
            groups: [],
            currentGroupId: null,
            currentSubgroupId: null,
            expandedGroups: new Set(),
            expandedSubgroups: new Set(),  // Êñ∞Â¢ûÔºöÂ±ïÂºÄÁöÑÂ≠êÂàÜÁªÑ
            groupSearchKeyword: '',
            methodFilter: '',
            searchKeyword: '',
            swaggerUI: null
        };

        // ==================== DOM ÂÖÉÁ¥† ====================
        const Elements = {
            groupList: document.getElementById('group-list'),
            swaggerUI: document.getElementById('swagger-ui'),
            totalGroups: document.getElementById('total-groups'),
            totalApis: document.getElementById('total-apis'),
            sidebarSearchInput: document.getElementById('sidebar-search-input'),
            apiSearchInput: document.getElementById('api-search-input'),
            methodFilterBtns: document.getElementById('method-filter-btns'),
            toolbarTitle: document.getElementById('toolbar-title'),
            toolbarSubtitle: document.getElementById('toolbar-subtitle')
        };

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function countTotalApis(groups) {
            return groups.reduce((total, group) => total + (group.count || 0), 0);
        }

        function getGroupApiCount(group) {
            if (group.subgroups && group.subgroups.length > 0) {
                return group.subgroups.reduce((sum, sub) => sum + (sub.count || 0), 0);
            }
            return group.count || 0;
        }

        // Ê†áÂáÜÂåñÂàÜÁªÑÊï∞ÊçÆÊ†ºÂºèÔºàÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÂ≠êÂàÜÁªÑÔºâ
        function normalizeGroups(groups) {
            return groups.map(group => ({
                ...group,
                id: group.name,
                display_name: group.name,
                api_count: group.count || 0,
                icon: 'üìÅ',
                // ÈÄíÂΩíÂ§ÑÁêÜ‰∫åÁ∫ßÂàÜÁªÑÊï∞ÊçÆ
                subgroups: normalizeSubgroups(group.subgroups || [])
            }));
        }

        // ÈÄíÂΩíÊ†áÂáÜÂåñÂ≠êÂàÜÁªÑ
        function normalizeSubgroups(subgroups) {
            return subgroups.map(sub => ({
                ...sub,
                id: sub.prefix || sub.name,
                display_name: sub.name || sub.prefix,
                api_count: sub.count || 0,
                prefix: sub.prefix,
                // ÈÄíÂΩíÂ§ÑÁêÜÂµåÂ•óÁöÑÂ≠êÂàÜÁªÑ
                subgroups: normalizeSubgroups(sub.subgroups || [])
            }));
        }

        // ==================== API ËØ∑Ê±Ç ====================
        async function fetchGroups() {
            const response = await fetch(CONFIG.tagsUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        // ==================== Swagger UI ÁÆ°ÁêÜ ====================
        function initSwaggerUI(tag, prefix = null) {
            // ÊûÑÂª∫ Schema URL
            let schemaUrl = `${CONFIG.schemaUrl}?tags=${encodeURIComponent(tag)}`;
            if (prefix) {
                schemaUrl += `&prefix=${encodeURIComponent(prefix)}`;
            }

            // ÈîÄÊØÅÊóßÂÆû‰æã
            if (AppState.swaggerUI) {
                Elements.swaggerUI.innerHTML = '';
            }

            // ÂàõÂª∫Êñ∞ÁöÑ Swagger UI ÂÆû‰æã
            AppState.swaggerUI = SwaggerUIBundle({
                url: schemaUrl,
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl,
                    // Ëá™ÂÆö‰πâËøáÊª§Êèí‰ª∂
                    () => ({
                        fn: {
                            opsFilter: (taggedOps, phrase) => {
                                // Â∫îÁî®ÊêúÁ¥¢ÂÖ≥ÈîÆËØçËøáÊª§
                                if (AppState.searchKeyword) {
                                    const keyword = AppState.searchKeyword.toLowerCase();
                                    return taggedOps.filter((tagObj) => {
                                        return tagObj.get('operations').some((op) => {
                                            const path = op.get('path') || '';
                                            const summary = op.get('operation')?.get('summary') || '';
                                            const description = op.get('operation')?.get('description') || '';
                                            return path.toLowerCase().includes(keyword) ||
                                                   summary.toLowerCase().includes(keyword) ||
                                                   description.toLowerCase().includes(keyword);
                                        });
                                    }).map((tagObj) => {
                                        return tagObj.set('operations', tagObj.get('operations').filter((op) => {
                                            const path = op.get('path') || '';
                                            const summary = op.get('operation')?.get('summary') || '';
                                            const description = op.get('operation')?.get('description') || '';
                                            return path.toLowerCase().includes(keyword) ||
                                                   summary.toLowerCase().includes(keyword) ||
                                                   description.toLowerCase().includes(keyword);
                                        }));
                                    });
                                }
                                return taggedOps;
                            }
                        }
                    })
                ],
                layout: "StandaloneLayout",
                docExpansion: "list",
                defaultModelsExpandDepth: -1,
                filter: true,
                showExtensions: false,
                showCommonExtensions: false,
                supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch'],
                onComplete: () => {
                    // Â∫îÁî®ÊñπÊ≥ïËøáÊª§
                    applyMethodFilter();
                    // Â∫îÁî®ÊêúÁ¥¢ËøáÊª§
                    applySearchFilter();
                }
            });
        }

        function applyMethodFilter() {
            const method = AppState.methodFilter;
            if (!method) {
                // ÊòæÁ§∫ÊâÄÊúâÊñπÊ≥ï
                document.querySelectorAll('.swagger-ui .opblock').forEach(el => {
                    el.style.display = '';
                });
                return;
            }

            // ÈöêËóè‰∏çÂåπÈÖçÁöÑÊñπÊ≥ï
            document.querySelectorAll('.swagger-ui .opblock').forEach(el => {
                const isMatch = el.classList.contains(`opblock-${method}`);
                el.style.display = isMatch ? '' : 'none';
            });

            // ÈöêËóèÁ©∫ÁöÑ tag ÁªÑ
            document.querySelectorAll('.swagger-ui .opblock-tag-section').forEach(section => {
                const visibleOps = section.querySelectorAll('.opblock:not([style*="display: none"])');
                section.style.display = visibleOps.length > 0 ? '' : 'none';
            });
        }

        function applySearchFilter() {
            const keyword = AppState.searchKeyword.toLowerCase();
            if (!keyword) {
                document.querySelectorAll('.swagger-ui .opblock').forEach(el => {
                    if (!AppState.methodFilter || el.classList.contains(`opblock-${AppState.methodFilter}`)) {
                        el.style.display = '';
                    }
                });
                return;
            }

            // ËøáÊª§Êìç‰ΩúÂùó
            document.querySelectorAll('.swagger-ui .opblock').forEach(el => {
                const path = el.querySelector('.opblock-summary-path')?.textContent?.toLowerCase() || '';
                const description = el.querySelector('.opblock-summary-description')?.textContent?.toLowerCase() || '';
                const isMatch = path.includes(keyword) || description.includes(keyword);

                // ÂêåÊó∂ËÄÉËôëÊñπÊ≥ïËøáÊª§
                const methodMatch = !AppState.methodFilter || el.classList.contains(`opblock-${AppState.methodFilter}`);

                el.style.display = (isMatch && methodMatch) ? '' : 'none';
            });

            // ÈöêËóèÁ©∫ÁöÑ tag ÁªÑ
            document.querySelectorAll('.swagger-ui .opblock-tag-section').forEach(section => {
                const visibleOps = section.querySelectorAll('.opblock:not([style*="display: none"])');
                section.style.display = visibleOps.length > 0 ? '' : 'none';
            });
        }

        // ==================== Ê∏≤ÊüìÂáΩÊï∞ ====================

        // ÈÄíÂΩíÊ∏≤ÊüìÂ≠êÂàÜÁªÑÂàóË°®
        function renderSubgroupList(groupId, subgroups, level = 1) {
            if (!subgroups || subgroups.length === 0) return '';

            const indent = 46 + (level - 1) * 20;  // ÊØèÁ∫ßÂ¢ûÂä† 20px Áº©Ëøõ

            return subgroups.map(sub => {
                const hasNestedSubgroups = sub.has_subgroups && sub.subgroups && sub.subgroups.length > 0;
                const isExpanded = AppState.expandedSubgroups && AppState.expandedSubgroups.has(sub.id);
                const isActive = AppState.currentSubgroupId === sub.id;

                return `
                    <div class="subgroup-item-wrapper">
                        <div class="subgroup-item ${isActive ? 'active' : ''} ${hasNestedSubgroups ? 'has-children' : ''}"
                             style="padding-left: ${indent}px;"
                             onclick="handleSubgroupClick(event, '${groupId}', '${sub.id}', '${sub.prefix || ''}', ${hasNestedSubgroups})">
                            ${hasNestedSubgroups ? `<span class="subgroup-arrow ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>` : ''}
                            <span class="subgroup-prefix">${sub.display_name || sub.name}</span>
                            <span class="subgroup-count">${sub.api_count || sub.count || 0}</span>
                            ${hasNestedSubgroups ? '<span class="subgroup-badge">Âê´Â≠êÂàÜÁªÑ</span>' : ''}
                        </div>
                        ${hasNestedSubgroups && isExpanded ? `
                            <div class="nested-subgroup-list">
                                ${renderSubgroupList(groupId, sub.subgroups, level + 1)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderGroupList() {
            const filterLower = AppState.groupSearchKeyword.toLowerCase();

            const filteredGroups = AppState.groups.filter(group => {
                if (!filterLower) return true;
                // ÊêúÁ¥¢ÁªÑÂêç
                if (group.name.toLowerCase().includes(filterLower)) return true;
                // ÊêúÁ¥¢Â≠êÂàÜÁªÑÂêç
                if (group.subgroups) {
                    return group.subgroups.some(sub =>
                        (sub.name || '').toLowerCase().includes(filterLower) ||
                        (sub.prefix || '').toLowerCase().includes(filterLower)
                    );
                }
                return false;
            });

            if (filteredGroups.length === 0) {
                Elements.groupList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂàÜÁªÑ</div>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredGroups.forEach(group => {
                const isExpanded = AppState.expandedGroups.has(group.id);
                const isActive = AppState.currentGroupId === group.id && !AppState.currentSubgroupId;
                const apiCount = group.count || 0;
                const hasSubgroups = group.has_subgroups && group.subgroups && group.subgroups.length > 0;

                html += `
                    <div class="group-item" data-group-id="${group.id}">
                        <div class="group-header ${isActive ? 'active' : ''}" onclick="handleGroupClick('${group.id}')">
                            ${hasSubgroups ? `
                                <span class="group-arrow ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
                            ` : '<span class="group-arrow"></span>'}
                            <span class="group-icon">${group.icon || 'üìÅ'}</span>
                            <div class="group-info">
                                <span class="group-name">${group.display_name || group.name}</span>
                            </div>
                            <span class="group-count">${apiCount}</span>
                        </div>
                        ${hasSubgroups ? `
                            <div class="subgroup-list ${isExpanded ? 'expanded' : ''}">
                                ${renderSubgroupList(group.id, group.subgroups)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            Elements.groupList.innerHTML = html;
        }

        function updateToolbarTitle(title, subtitle) {
            Elements.toolbarTitle.innerHTML = `${title}<small id="toolbar-subtitle">${subtitle}</small>`;
        }

        function showLoading() {
            Elements.swaggerUI.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>Âä†ËΩΩ API ÊñáÊ°£‰∏≠...</div>
                </div>
            `;
        }

        function showError(message) {
            Elements.swaggerUI.innerHTML = `
                <div class="error-state">
                    <div class="error-state-icon">‚ùå</div>
                    <div>${message}</div>
                    <button class="retry-btn" onclick="retryLoad()">ÈáçËØï</button>
                </div>
            `;
        }

        // ==================== ‰∫ã‰ª∂Â§ÑÁêÜ ====================
        function handleGroupClick(groupId) {
            const group = AppState.groups.find(g => g.id === groupId);
            if (!group) return;

            const hasSubgroups = group.has_subgroups && group.subgroups && group.subgroups.length > 0;

            if (hasSubgroups) {
                // ÊúâÂ≠êÂàÜÁªÑÔºöÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
                if (AppState.expandedGroups.has(groupId)) {
                    AppState.expandedGroups.delete(groupId);
                } else {
                    // ÊâãÈ£éÁê¥ÊïàÊûúÔºöÊî∂Ëµ∑ÂÖ∂‰ªñÂàÜÁªÑ
                    AppState.expandedGroups.clear();
                    AppState.expandedGroups.add(groupId);
                    // Ê∏ÖÁ©∫Â≠êÂàÜÁªÑÂ±ïÂºÄÁä∂ÊÄÅ
                    AppState.expandedSubgroups.clear();
                }
                AppState.currentGroupId = groupId;
                AppState.currentSubgroupId = null;

                // ÊâæÂà∞Á¨¨‰∏Ä‰∏™Âè∂Â≠êËäÇÁÇπÔºàÊ≤°ÊúâÂµåÂ•óÂ≠êÂàÜÁªÑÁöÑÔºâÂπ∂Âä†ËΩΩ
                const firstLeaf = findFirstLeafSubgroup(group.subgroups);
                if (firstLeaf) {
                    AppState.currentSubgroupId = firstLeaf.id;
                    const displayTitle = buildDisplayTitle(group.name, firstLeaf);
                    loadSwaggerUI(group.name, firstLeaf.prefix, displayTitle);

                    // Â±ïÂºÄÂà∞ËØ•Âè∂Â≠êËäÇÁÇπÁöÑË∑ØÂæÑ
                    expandPathToSubgroup(group.subgroups, firstLeaf.id);
                }
            } else {
                // Êó†Â≠êÂàÜÁªÑÔºöÁõ¥Êé•ÊòæÁ§∫ API ÂàóË°®
                AppState.expandedGroups.clear();
                AppState.expandedSubgroups.clear();
                AppState.currentGroupId = groupId;
                AppState.currentSubgroupId = null;
                loadSwaggerUI(group.name, null, group.name);
            }

            renderGroupList();
        }

        // ÊâæÂà∞Á¨¨‰∏Ä‰∏™Âè∂Â≠êËäÇÁÇπÔºàÊ≤°ÊúâÂµåÂ•óÂ≠êÂàÜÁªÑÁöÑÔºâ
        function findFirstLeafSubgroup(subgroups) {
            for (const sub of subgroups) {
                if (!sub.has_subgroups || !sub.subgroups || sub.subgroups.length === 0) {
                    return sub;
                }
                const leaf = findFirstLeafSubgroup(sub.subgroups);
                if (leaf) return leaf;
            }
            return null;
        }

        // Â±ïÂºÄÂà∞ÊåáÂÆöÂ≠êÂàÜÁªÑÁöÑË∑ØÂæÑ
        function expandPathToSubgroup(subgroups, targetId) {
            for (const sub of subgroups) {
                if (sub.id === targetId) return true;
                if (sub.subgroups && sub.subgroups.length > 0) {
                    if (expandPathToSubgroup(sub.subgroups, targetId)) {
                        AppState.expandedSubgroups.add(sub.id);
                        return true;
                    }
                }
            }
            return false;
        }

        function handleSubgroupClick(event, groupId, subgroupId, prefix, hasNestedSubgroups = false) {
            event.stopPropagation();

            const group = AppState.groups.find(g => g.id === groupId);
            if (!group || !group.subgroups) return;

            // ÈÄíÂΩíÊü•ÊâæÂ≠êÂàÜÁªÑ
            const subgroup = findSubgroupById(group.subgroups, subgroupId);
            if (!subgroup) return;

            // Â¶ÇÊûúÊúâÂµåÂ•óÂ≠êÂàÜÁªÑÔºåÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅ
            if (hasNestedSubgroups) {
                if (AppState.expandedSubgroups.has(subgroupId)) {
                    AppState.expandedSubgroups.delete(subgroupId);
                } else {
                    AppState.expandedSubgroups.add(subgroupId);
                }
                // ‰∏çÁ´ãÂç≥Âä†ËΩΩ SwaggerÔºåÂè™ÊòØÂ±ïÂºÄÂ≠êÂàÜÁªÑÂàóË°®
                renderGroupList();
                return;
            }

            // Ê≤°ÊúâÂµåÂ•óÂ≠êÂàÜÁªÑÔºåÂä†ËΩΩ Swagger UI
            AppState.currentGroupId = groupId;
            AppState.currentSubgroupId = subgroupId;

            // ÊûÑÂª∫ÊòæÁ§∫Ê†áÈ¢ò
            const displayTitle = buildDisplayTitle(group.name, subgroup);
            loadSwaggerUI(group.name, subgroup.prefix, displayTitle);
            renderGroupList();
        }

        // ÈÄíÂΩíÊü•ÊâæÂ≠êÂàÜÁªÑ
        function findSubgroupById(subgroups, targetId) {
            for (const sub of subgroups) {
                if (sub.id === targetId) return sub;
                if (sub.subgroups && sub.subgroups.length > 0) {
                    const found = findSubgroupById(sub.subgroups, targetId);
                    if (found) return found;
                }
            }
            return null;
        }

        // ÊûÑÂª∫ÊòæÁ§∫Ê†áÈ¢òÔºàÊ†πÊçÆ prefix ÁîüÊàêÂ±ÇÁ∫ßË∑ØÂæÑÔºâ
        function buildDisplayTitle(groupName, subgroup) {
            const prefix = subgroup.prefix || '';
            const parts = prefix.split('/').filter(p => p);

            if (parts.length === 0) {
                return groupName;
            }

            if (parts.length === 1) {
                return `${groupName} / ${subgroup.display_name || subgroup.name}`;
            }

            // Â¶ÇÊûúÁ¨¨‰∏Ä‰∏™Ë∑ØÂæÑÊÆµ‰∏éÂàÜÁªÑÂêçÁõ∏ÂêåÔºåÂéªÈô§ÈáçÂ§ç
            if (parts[0].toLowerCase() === groupName.toLowerCase()) {
                parts.shift(); // ÁßªÈô§Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
            }

            return `${groupName} / ${parts.join(' / ')}`;
        }

        function loadSwaggerUI(tag, prefix, displayTitle) {
            // ÈáçÁΩÆÊêúÁ¥¢ÂíåËøáÊª§
            AppState.searchKeyword = '';
            AppState.methodFilter = '';
            Elements.apiSearchInput.value = '';
            updateMethodFilterBtns('');

            updateToolbarTitle(displayTitle, 'Âä†ËΩΩ‰∏≠...');
            showLoading();

            try {
                initSwaggerUI(tag, prefix);
                updateToolbarTitle(displayTitle, '');
            } catch (error) {
                console.error('Âä†ËΩΩ Swagger UI Â§±Ë¥•:', error);
                showError('Âä†ËΩΩ API ÊñáÊ°£Â§±Ë¥•');
            }
        }

        function retryLoad() {
            if (AppState.currentGroupId) {
                const group = AppState.groups.find(g => g.id === AppState.currentGroupId);
                if (group) {
                    if (AppState.currentSubgroupId) {
                        const subgroup = group.subgroups?.find(s => s.id === AppState.currentSubgroupId);
                        if (subgroup) {
                            loadSwaggerUI(group.name, subgroup.prefix, `${group.name} / ${subgroup.display_name || subgroup.name}`);
                            return;
                        }
                    }
                    loadSwaggerUI(group.name, null, group.name);
                }
            }
        }

        function handleMethodFilter(method) {
            AppState.methodFilter = method;
            updateMethodFilterBtns(method);
            applyMethodFilter();
            applySearchFilter();
        }

        function updateMethodFilterBtns(activeMethod) {
            const btns = Elements.methodFilterBtns.querySelectorAll('.method-btn');
            btns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === activeMethod);
            });
        }

        function handleSearchInput(keyword) {
            AppState.searchKeyword = keyword;
            applySearchFilter();
        }

        // ==================== ÂàùÂßãÂåñ ====================
        async function init() {
            try {
                // Âä†ËΩΩÂàÜÁªÑÊï∞ÊçÆ
                const data = await fetchGroups();
                const rawGroups = data.tags || data.groups || data;
                AppState.groups = normalizeGroups(rawGroups);

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                Elements.totalGroups.textContent = AppState.groups.length;
                Elements.totalApis.textContent = countTotalApis(AppState.groups);

                // Ê∏≤ÊüìÂàÜÁªÑÂàóË°®
                renderGroupList();

                // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™ÂàÜÁªÑ
                if (AppState.groups.length > 0) {
                    handleGroupClick(AppState.groups[0].id);
                }
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                Elements.groupList.innerHTML = `
                    <div class="error-state">
                        <div class="error-state-icon">‚ùå</div>
                        <div>Âä†ËΩΩÂàÜÁªÑÂ§±Ë¥•</div>
                        <button class="retry-btn" onclick="init()">ÈáçËØï</button>
                    </div>
                `;
            }
        }

        // ==================== ‰∫ã‰ª∂ÁªëÂÆö ====================
        // ÂàÜÁªÑÊêúÁ¥¢
        Elements.sidebarSearchInput.addEventListener('input', (e) => {
            AppState.groupSearchKeyword = e.target.value;
            renderGroupList();
        });

        // API ÊêúÁ¥¢ÔºàÈò≤ÊäñÔºâ
        const debouncedSearch = debounce(handleSearchInput, CONFIG.debounceDelay);
        Elements.apiSearchInput.addEventListener('input', (e) => {
            debouncedSearch(e.target.value);
        });

        // HTTP ÊñπÊ≥ïËøáÊª§
        Elements.methodFilterBtns.addEventListener('click', (e) => {
            const btn = e.target.closest('.method-btn');
            if (btn) {
                handleMethodFilter(btn.dataset.method);
            }
        });

        // ÂêØÂä®Â∫îÁî®
        init();
    </script>
</body>
</html>